---
title: "Identifying the role of foraging state on hunt effficiency"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook, analysing zebrafish tracking data 
for foraging state as indicated by Marquez et al 2019.
Zebrafish appear to spontaneously switch between an exploratory and exploitation phase that grossly defines their behavioural mode. 
The state can be read out be measuring trajectory dispersal over a fixed period of time (5 sec), 
According to Marquez et al  2020 Measures of dispersal should appear bimodal, with short dispersals indicating exploitation phase.

Given our behavioural recordings are not continuous, and exclude periods when the larva are swimming around the boundary, it is not certain whether we would be able to detect exploratory phases. These tend to be circling around the border of the petri-dish, as the fish attempts to swim forward. Nevertheless as we are interested in the mode-state under which hunt-events are executed, then we expect that some of these events should be executed during exploratory behaviour and this should be detectable - (dispersal, movement rates etc).


  Hypothesis being tested :
  
  - Does the execution of the kinematic adaptations of capture efficiency, found in the experience larvae,  depend on foraging state ?
  - Does experience modify the foraging intervals?
  - Does expansion of foraging interval explain the higher evoked hunt-rate of the LF group?

### Identify state using dispersal
5s window measure radius encompassing trajectory

```{r Calc Dispersion of Each Trajectory}

## Init  Code 
setwd("/home/kostasl/workspace/zebrafishtrack/Rplots")
#setwd(here())
source("config_lib.R")
source("TrajectoryAnalysis.r")

setEnvFileLocations("LAPTOP") #HOME,OFFICE,#LAPTOP
load(paste(strDatDir,"datAllFramesFix1_Ds-5-19.RData",sep="/"))
load(paste(strDatDir,"groupsrcdatListPerDataSet_Ds-5-19.RData",sep="/"))


tsec_timeWindow <- 5

vexpID <- unique(datAllFrames$expID)
e <- vexpID[1]
##'Add new column
datAllFrames$Dispersion <- NA

start.time <- Sys.time()
 
datDispersion <- data.frame()
i = 0;

## For Each Recording Event of each experiment
  for (e in vexpID)
  {
    i = i + 1
    message(i,". ExpID:",e)
    
    
    stopifnot(is.numeric(e) & e > 0)
    #stopifnot(i < 3) ##Test Run
    
    vEventID = unique((datAllFrames[datAllFrames$expID == e,]$eventID))
  
    
    ##For Each Event
    for (ev in vEventID)
    {
      datEventFrames <- datAllFrames[datAllFrames$expID == e & datAllFrames$eventID == ev & datAllFrames$posX != 0 ,]  
    
      meanfps <-  head(datEventFrames$fps,1)
      groupID <- as.character(unique(datEventFrames$groupID) )
      message(paste("ExpID:",e,"EventID:",ev,"fps:",meanfps," nFrames:",NROW(datEventFrames)) )
      #  We may Need to Identify TrackLet Units, Avoid speed calc errors due to fish going in and out of view
      #  PROCESS TrackLets #
      #vTracklets <- unique(datEventFrames$trackletID)
      
      if (NROW(datEventFrames) < 10)
        next() ##No Frames In event - Move to next one
      
      vEventDispersion <- calcTrajectoryDispersion(datEventFrames,tsec_timeWindow) 
      datEventDispersion <- data.frame(expID=e,
                                       eventID=ev,
                                       Dispersion=(vEventDispersion),
                                       Dispersion_norm=(vEventDispersion),
                                       frameRow=as.integer(row.names( datEventFrames))  )

      ##Append to main Dispersion Data Frame
      datDispersion <- rbind(datEventDispersion,datDispersion)
      
    }##For Each Event

  ## \TODO Normalize Dispersion Per Larva Here
  datExpDisp <- datDispersion[datDispersion$expID == e,]
  range_Disp <- range(datExpDisp$Dispersion,na.rm=TRUE)
   if (!is.na(range_Disp))
      datDispersion[datDispersion$expID == e,]$Dispersion_norm <- datExpDisp$Dispersion/range_Disp[2]
  
  end.time <- Sys.time()
  time.taken <- end.time - start.time
  print(time.taken)
  
  }#For Each Exp ID

  end.time <- Sys.time()
  time.taken <- end.time - start.time
  print(time.taken)
  
datDispersion <- cbind(datDispersion,groupID=datAllFrames[datDispersion$frameRow,]$groupID)
  
saveRDS(datDispersion,file=paste0(strDataExportDir,"/foragingState_Dispersion",tsec_timeWindow,"sec.rds") )

hist(datDispersion$Dispersion_norm     )

```
## Detect Exploration -Exploitation via dispersion
 
 In Marquez et al. 2019 Ext Fig 3a, the dispersion of each larva is normalized against its own range before the overall (bimodal) distribution is shown.
 Without normalizing the distrubution looks like this:
```{r plot dispersion distribution }

hist(datDispersion$Dispersion,breaks=100)

```
After normalizing for each larva this distrubution looks:
```{r plot normalized dispersion distribution }
  

datDispersion = readRDS(file=paste0(strDataExportDir,"/foragingState_Dispersion",tsec_timeWindow,"sec.rds") )
AllRange <- range(datDispersion$Dispersion,na.rm=TRUE)

## Normed over all Recorded Dispersions
hist(datDispersion[datDispersion$groupID == 'LE', ]$Dispersion/AllRange[2],breaks=100)
hist(datDispersion[datDispersion$groupID == 'NE', ]$Dispersion/AllRange[2],breaks=100)
hist(datDispersion[datDispersion$groupID == 'DE', ]$Dispersion/AllRange[2],breaks=100)

hist(datDispersion[datDispersion$groupID == 'LL', ]$Dispersion/AllRange[2],breaks=100)
hist(datDispersion[datDispersion$groupID == 'NL', ]$Dispersion/AllRange[2],breaks=100)
hist(datDispersion[datDispersion$groupID == 'DL', ]$Dispersion/AllRange[2],breaks=100)

TH_DISP <- 0.12

datExploreTrajectory.LE <- datAllFrames[datDispersion[datDispersion$groupID == 'LE' & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
datExploitTrajectory.LE <- datAllFrames[datDispersion[datDispersion$groupID == 'LE' & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]


datExploreTrajectory.LL <- datAllFrames[datDispersion[datDispersion$groupID == 'LL' & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
datExploitTrajectory.LL <- datAllFrames[datDispersion[datDispersion$groupID == 'LL' & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]

datExploreTrajectory.NE <- datAllFrames[datDispersion[datDispersion$groupID == 'NE' & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
datExploitTrajectory.NE <- datAllFrames[datDispersion[datDispersion$groupID == 'NE' & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]

datExploreTrajectory.NL <- datAllFrames[datDispersion[datDispersion$groupID == 'NL' & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
datExploitTrajectory.NL <- datAllFrames[datDispersion[datDispersion$groupID == 'NL' & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]

datExploreTrajectory.DE <- datAllFrames[datDispersion[datDispersion$groupID == 'DE' & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
datExploitTrajectory.DE <- datAllFrames[datDispersion[datDispersion$groupID == 'DE' & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]

datExploreTrajectory.DL <- datAllFrames[datDispersion[datDispersion$groupID == 'DL' & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
datExploitTrajectory.DL <- datAllFrames[datDispersion[datDispersion$groupID == 'DL' & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]

#Plot Individual Trajectories
datGroupExploreTraj <- datExploreTrajectory.LL 
datGroupExploitTraj <- datExploitTrajectory.LL 

vexpID <-  unique(datGroupExploitTraj$exp) 

badd <- FALSE
i<- 0
par(mfrow=c(2,NROW(vexpID))) ##MultiPlot Page
par(mar=c(1,1,1,1))
layout(matrix(seq(1,NROW(vexpID)), 2,NROW(vexpID) , byrow = TRUE))

for (e in vexpID)
{
    if (is.na(e))
      next()
  
    datTraj <- datGroupExploreTraj[datGroupExploreTraj$expID == e & !is.na(datGroupExploreTraj$posX),]
    plot(datTraj$posX,datTraj$posY,type="p",col="blue",cex=0.1)
    
    datTraj <- datGroupExploitTraj[datGroupExploitTraj$expID == e & !is.na(datGroupExploitTraj$posX),]
    points(datTraj$posX,datTraj$posY,type="p",col="red",cex=0.1)

    badd <- TRUE
    #stopifnot(i < 5)
    i <- i+1
}

# LF Sporttaneous
plot(datExploreTrajectory.LE$posX,datExploreTrajectory.LE$posY,type="l",col="red")
lines(datExploitTrajectory.LE$posX,datExploitTrajectory.LE$posY,type="l",col="blue")

## LF Evoked
plot(datExploreTrajectory.LL$posX,datExploreTrajectory.LL$posY,type="l",col="red")
lines(datExploitTrajectory.LL$posX,datExploitTrajectory.LL$posY,type="l",col="blue")

# NE Spontaneous
plot(datExploreTrajectory.NE$posX,datExploreTrajectory.NE$posY,type="l",col="red")
lines(datExploitTrajectory.NE$posX,datExploitTrajectory.NE$posY,type="l",col="blue")

# NL Spontaneous
plot(datExploreTrajectory.NL$posX,datExploreTrajectory.NL$posY,type="l",col="red")
lines(datExploitTrajectory.NL$posX,datExploitTrajectory.NL$posY,type="l",col="blue")

# DE Spontaneous
plot(datExploreTrajectory.DE$posX,datExploreTrajectory.DE$posY,type="l",col="red")
lines(datExploitTrajectory.DE$posX,datExploitTrajectory.DE$posY,type="l",col="blue")

# DL Spontaneous
plot(datExploreTrajectory.DL$posX,datExploreTrajectory.DL$posY,type="l",col="red")
lines(datExploitTrajectory.DL$posX,datExploitTrajectory.DL$posY,type="l",col="blue")


### Normed Per Larva
hist(datDispersion[datDispersion$groupID == 'LE', ]$Dispersion_norm,breaks=100)
hist(datDispersion[datDispersion$groupID == 'NE', ]$Dispersion_norm,breaks=100)
hist(datDispersion[datDispersion$groupID == 'DE', ]$Dispersion_norm,breaks=100)

hist(datDispersion[datDispersion$groupID == 'LL', ]$Dispersion_norm,breaks=100)
hist(datDispersion[datDispersion$groupID == 'NL', ]$Dispersion_norm,breaks=100)
hist(datDispersion[datDispersion$groupID == 'DL', ]$Dispersion_norm,breaks=100)
```

 


The standard way of representing these systems uses matrix notation :
\[\dot{\bf{x}}  = \bf{Fx} + Gu + w  \], where $u$ is the input vector and $w$ the noise.
The 1st order LP filter from above put in to this form would simply be F=-1/T,G=0,w=\eta/T.


'''

## Normalize For Each Larva and - Plot Again

datDispersion <- readRDS(file=paste0(strDataExportDir,"/foragingState_Dispersion5sec.rds") )

vexpID <- unique(datDispersion$expID)


datDispersionNorm$Dispersion_norm <- datDispersionNorm$Dispersion ##Copy To Create New Dataframe column

  for (e in vexpID)
  {
    i = i + 1
    message(i,". ExpID:",e)
    
    stopifnot(is.numeric(e) & e > 0)
    
     datExpDisp <- datDispersion[datDispersion$expID == e,]
     vEventID = unique(datExpDisp$eventID)
     range_Disp <- range(datExpDisp$Dispersion,na.rm=TRUE)
     if (!is.na(range_Disp))
     {
        datDispersionNorm[datDispersionNorm$expID == e,]$Dispersion_norm <- datExpDisp$Dispersion/range_Disp[2]
     }
     
  }

#datDispersion <- merge(datDispersion,datDispersionNorm,)
saveRDS(datDispersion,file=paste0(strDataExportDir,"/foragingState_Dispersion5secNorm.rds") )



