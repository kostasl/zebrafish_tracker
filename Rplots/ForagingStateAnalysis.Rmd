---
title: "Identifying the role of foraging state on hunt effficiency"
output:
#  pdf_document:
#    extra_dependencies: "subfig"
html_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook, analysing zebrafish tracking data 
for foraging state as indicated by Marquez et al 2019.
Zebrafish appear to spontaneously switch between an exploratory and exploitation phase that grossly defines their behavioural mode. 
The state can be read out be measuring trajectory dispersal over a fixed period of time (5 sec), 
According to Marquez et al  2020 Measures of dispersal should appear bimodal, with short dispersals indicating exploitation phase.

Given our behavioural recordings are not continuous, and exclude periods when the larva are swimming around the boundary, it is not certain whether we would be able to detect exploratory phases. These tend to be circling around the border of the petri-dish, as the fish attempts to swim forward. Nevertheless as we are interested in the mode-state under which hunt-events are executed, then we expect that some of these events should be executed during exploratory behaviour and this should be detectable - (dispersal, movement rates etc).


  Hypothesis being tested :
  
  - Does the execution of the kinematic adaptations of capture efficiency, found in the experience larvae,  depend on foraging state ?
  - Does experience modify the foraging intervals?
  - Does expansion of foraging interval explain the higher evoked hunt-rate of the LF group?

### Identify state using dispersal
5s window measure radius encompassing trajectory



```{r, setup, echo=FALSE,results='hide', cache=FALSE}
## Init  Code 
setwd("/home/kostasl/workspace/zebrafishtrack/Rplots")
#setwd(here())
source("config_lib.R")
source("TrajectoryAnalysis.r")

setEnvFileLocations("LAPTOP") #HOME,OFFICE,#LAPTOP
load(paste(strDatDir,"datAllFramesFix1_Ds-5-19.RData",sep="/"))
load(paste(strDatDir,"groupsrcdatListPerDataSet_Ds-5-19.RData",sep="/"))

tsec_timeWindow <- 5
thres_dispersion_class <- 0.2

datDispersion = readRDS(file=paste0(strDataExportDir,"/foragingState_Dispersion",tsec_timeWindow,"sec.rds") )
AllRange <- range(datDispersion$Dispersion,na.rm=TRUE)

if (NROW(datDispersion) == 0)
{
  message("Calculate Trajectory Dispersions")
  datDispersion <- calcTrajectoryDispersions
}

```

```{r Function to plot trajectories for each larva, coloured based on dispersion, figures-function, fig.show="hold", out.width="50%", echo=FALSE }

## Plot function for scatter plot of colour coded larval trajectories, separated into explore and exploit vectors 
### 
plotExploreExploitTrajectories <- function(groupID,datGroupExploreTraj,datGroupExploitTraj)
{
  vexpID <-  unique(datGroupExploitTraj$exp) 
  #par(mfrow=c(2,NROW(vexpID))) ##MultiPlot Page
  #par(mar=c(1,1,1,1))
  #layout(matrix(seq(1,NROW(vexpID)), 2,NROW(vexpID) , byrow = TRUE))
  i <- 0
  for (e in vexpID)
  {
      if (is.na(e))
        next()
      x1  <- seq(0, 640 )
      y1 <- seq(0, 550 )

      print(e)
      plot(0,0,ylim=range(y1),xlim=range(x1), type="l",col="red",main=paste(groupID,e) )
      
      datTraj <- datGroupExploreTraj[datGroupExploreTraj$expID == e & !is.na(datGroupExploreTraj$posX),]
      if (NROW(datTraj))
        points(datTraj$posX,datTraj$posY,type="p",col="blue",cex=0.1);

      datTraj <- datGroupExploitTraj[datGroupExploitTraj$expID == e & !is.na(datGroupExploitTraj$posX),]
      if (NROW(datTraj))
        points(datTraj$posX,datTraj$posY,type="p",col="red",cex=0.1)
  
      badd <- TRUE
      #stopifnot(i < 5)
      i <- i+1
  } ## For Each Event
    
}
##
# Function Plot Individual Trajectories for a group, split between exploration and exploitation
# given a *global* normalized dispersion measures threshold 
##
plotGlobalNormDispersionTrajectories <- function(groupID, datAllFrames, datDispersion, TH_DISP = 0.2)
{

  datGroupExploreTraj <- datAllFrames[datDispersion[datDispersion$groupID == groupID & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
  datGroupExploitTraj <- datAllFrames[datDispersion[datDispersion$groupID == groupID & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]
  ## Call Plot Function
  plotExploreExploitTrajectories(groupID,datGroupExploreTraj,datGroupExploitTraj)
  
} ## end of plot Functon

##
# Function Plot Individual Trajectories for a group, split between exploration and exploitation
# given a *local* normalized dispersion measures threshold / the classification is relative to the mobility measure of each larvae in each condition 
##
plotExpNormDispersionTrajectories <- function(groupID, datAllFrames, datDispersion, TH_DISP = 0.2)
{

  datGroupExploreTraj <- datAllFrames[datDispersion[datDispersion$groupID == groupID & datDispersion$Dispersion_norm >= TH_DISP,"frameRow"],]
  datGroupExploitTraj <- datAllFrames[datDispersion[datDispersion$groupID == groupID & datDispersion$Dispersion_norm < TH_DISP,"frameRow"],]
  ## Call Plot Function
  plotExploreExploitTrajectories(groupID,datGroupExploreTraj,datGroupExploitTraj)
  
} ## end of plot Functon


```

```{r Calc Dispersion of Each Trajectory}
calcTrajectoryDispersions <- function()
{

  datDispersion <- data.frame()
  vexpID <- unique(datAllFrames$expID)
  e <- vexpID[1]
  ##'Add new column
  datAllFrames$Dispersion <- NA
  
  start.time <- Sys.time()
   
  i = 0;

  ## For Each Recording Event of each experiment
    for (e in vexpID)
    {
      i = i + 1
      message(i,". ExpID:",e)
      
      
      stopifnot(is.numeric(e) & e > 0)
      #stopifnot(i < 3) ##Test Run
      
      vEventID = unique((datAllFrames[datAllFrames$expID == e,]$eventID))
    
      
      ##For Each Event
      for (ev in vEventID)
      {
        datEventFrames <- datAllFrames[datAllFrames$expID == e & datAllFrames$eventID == ev & datAllFrames$posX != 0 ,]  
      
        meanfps <-  head(datEventFrames$fps,1)
        groupID <- as.character(unique(datEventFrames$groupID) )
        message(paste("ExpID:",e,"EventID:",ev,"fps:",meanfps," nFrames:",NROW(datEventFrames)) )
        #  We may Need to Identify TrackLet Units, Avoid speed calc errors due to fish going in and out of view
        #  PROCESS TrackLets #
        #vTracklets <- unique(datEventFrames$trackletID)
        
        if (NROW(datEventFrames) < 10)
          next() ##No Frames In event - Move to next one
        
        vEventDispersion <- calcTrajectoryDispersion(datEventFrames,tsec_timeWindow) 
        datEventDispersion <- data.frame(expID=e,
                                         eventID=ev,
                                         Dispersion=(vEventDispersion),
                                         Dispersion_norm=(vEventDispersion),
                                         frameRow=as.integer(row.names( datEventFrames))  )
  
        ##Append to main Dispersion Data Frame
        datDispersion <- rbind(datEventDispersion,datDispersion)
        
      }##For Each Event
  
    ## \TODO Normalize Dispersion Per Larva Here - Dividing by the maximum dispersion
    datExpDisp <- datDispersion[datDispersion$expID == e,]
    range_Disp <- range(datExpDisp$Dispersion,na.rm=TRUE)
     if (!is.na(range_Disp))
        datDispersion[datDispersion$expID == e,]$Dispersion_norm <- datExpDisp$Dispersion/range_Disp[2]
    
    end.time <- Sys.time()
    time.taken <- end.time - start.time
    print(time.taken)
    
    }#For Each Exp ID
  
    end.time <- Sys.time()
    time.taken <- end.time - start.time
    print(time.taken)
    
  datDispersion <- cbind(datDispersion,groupID=datAllFrames[datDispersion$frameRow,]$groupID)
    
  saveRDS(datDispersion,file=paste0(strDataExportDir,"/foragingState_Dispersion",tsec_timeWindow,"sec.rds") )
  
  return (datDispersion)
} ## Calc Fuction

#hist(datDispersion$Dispersion_norm )
```

## Detect Exploration -Exploitation via dispersion
 
 In Marquez et al. 2019 Ext Fig 3a, the dispersion of each larva is normalized against its own range before the overall (bimodal) distribution is shown.
 Using my tracking data I calculated the dispersion at each tracked video frame and plot the distribution to examine if they are bimodal (here using the `r tsec_timeWindow` seconds window).
 
 Without normalizing the distribution is shown on the left, and a version normalized per max dispersion measured in each experiment is on the right :
 
```{r histograms of dispersion across groups, fig.show="hold", out.width="50%", echo=FALSE, results='hide'  }

hist(datDispersion$Dispersion,breaks=100,main="(All groups): Dispersion lengths per experiment ",xlab="Dispersion (mm)")
hist(datDispersion$Dispersion_norm,breaks=100,main="(All groups): Dispersion normalized",xlab="Dispersion (exp. norm)")

```

We then plot each experimental group individually, also examining the dispersion in evoked (in the presence of prey) and spontaneous (no prey) conditions separatellly.
Next we plot these for each experimental condition individually (non-Normalized):
```{r plot dispersion distributions per group, fig.show="hold", out.width="33%", echo=FALSE, results='hide'  }
# 
# ## Normed over all Recorded Dispersions
 hist(datDispersion[datDispersion$groupID == 'LE', ]$Dispersion,breaks=100,main="LF Spontaneous",xlab="Dispersion (mm)")
 hist(datDispersion[datDispersion$groupID == 'NE', ]$Dispersion,breaks=100,main="NF Spontaneous",xlab="Dispersion (mm)")
 hist(datDispersion[datDispersion$groupID == 'DE', ]$Dispersion,breaks=100,main="DF Spontaneous",xlab="Dispersion (mm)")

 hist(datDispersion[datDispersion$groupID == 'LL', ]$Dispersion,breaks=100,main="LF Evoked",xlab="Dispersion (mm)")
 hist(datDispersion[datDispersion$groupID == 'NL', ]$Dispersion,breaks=100,main="NF Evoked",xlab="Dispersion (mm)")
 hist(datDispersion[datDispersion$groupID == 'DL', ]$Dispersion,breaks=100,main="DF Evoked",xlab="Dispersion (mm)")
 
```


<!-- For completness, the following dispersions have been normalized to maximum trajectory dispersion found across all experiments (*global normalization*): -->


```{r plot globally normalized dispersion distributions, fig.show="hold", out.width="33%", echo=FALSE, results='hide',include=FALSE  }
# 
# ## Normed over all Recorded Dispersions
 hist(datDispersion[datDispersion$groupID == 'LE', ]$Dispersion/AllRange[2],breaks=100,main="LF Spontaneous",xlab="Dispersion (global norm. )")
 hist(datDispersion[datDispersion$groupID == 'NE', ]$Dispersion/AllRange[2],breaks=100,main="NF Spontaneous",xlab="Dispersion (global norm. )")
 hist(datDispersion[datDispersion$groupID == 'DE', ]$Dispersion/AllRange[2],breaks=100,main="DF Spontaneous",xlab="Dispersion (global norm. )")

 hist(datDispersion[datDispersion$groupID == 'LL', ]$Dispersion/AllRange[2],breaks=100,main="LF Evoked",xlab="Dispersion (global norm. .)")
 hist(datDispersion[datDispersion$groupID == 'NL', ]$Dispersion/AllRange[2],breaks=100,main="NF Evoked",xlab="Dispersion (global norm. )")
 hist(datDispersion[datDispersion$groupID == 'DL', ]$Dispersion/AllRange[2],breaks=100,main="DF Evoked",xlab="Dispersion (global norm. )")
 
```
Next, we examine the same dispesions normalized against the maximum dispersion calculated in the trajectory length of the respective experiment.
Each measured dispersion is divided by the max dispersion trajectory experiment,
(ie for each larva  this can be different in evoked or spontaneous conditions).

```{r,plot normalized dispersion distributions, fig.show="hold", out.width="33%", echo=FALSE, results='hide' }
### Normed Per Larva

hist(datDispersion[datDispersion$groupID == 'LE', ]$Dispersion_norm,breaks=100,main="LF Spontaneous",xlab="Dispersion  (norm per exp.)")
hist(datDispersion[datDispersion$groupID == 'NE', ]$Dispersion_norm,breaks=100,main="NF Spontaneous",xlab="Dispersion  (norm per exp.)")
hist(datDispersion[datDispersion$groupID == 'DE', ]$Dispersion_norm,breaks=100,main="DF Spontaneous",xlab="Dispersion  (norm per exp.)")

hist(datDispersion[datDispersion$groupID == 'LL', ]$Dispersion_norm,breaks=100,main="LF Evoked",xlab="Dispersion  (norm per exp.)")
hist(datDispersion[datDispersion$groupID == 'NL', ]$Dispersion_norm,breaks=100,main="NF Evoked",xlab="Dispersion  (norm per exp.)")
hist(datDispersion[datDispersion$groupID == 'DL', ]$Dispersion_norm,breaks=100,main="DF Evoked",xlab="Dispersion  (norm per exp.)")

```

# Measure Hunt rate per foraging state

```{r,  hunt-event foraging state analysis, fig.show="hold", out.width="50%", echo=FALSE, cache=TRUE }
source("DataLabelling/labelHuntEvents_lib.r")
message(paste(" Loading Hunt Event List to Analyse... "))
#load(file=paste(strDatDir,"/LabelledSet/",strProcDataFileName,".RData",sep="" )) ##Save With Dataset Idx Identifier
datHuntLabelledEventsSBMerged_fixed <- getLabelledHuntEventsSet() # readRDS(file=paste(strDatDir,"/LabelledSet/",strProcDataFileName,".rds",sep="" ))

#datGroupExploreTraj <- datAllFrames[datDispersion[datDispersion$groupID == groupID & datDispersion$Dispersion/AllRange[2] >= TH_DISP,"frameRow"],]
#datGroupExploitTraj <- datAllFrames[datDispersion[datDispersion$groupID == groupID & datDispersion$Dispersion/AllRange[2] < TH_DISP,"frameRow"],]

## Attach Frame Number to Dispersion Data
datDispersion <- cbind(datDispersion,frameN=datAllFrames[datDispersion[,"frameRow"],'frameN'])

## Extract HUnt Event Foraging State
### 1. Get Dispersion Measure of each hunt event
start.time <- Sys.time()
## MERGE Dispersion With HuntEvent Records
  # Need to convert to factor the GroupID factor( datHuntLabelledEventsSBMerged_fixed$groupID) 
  datHEventDispersion <- merge(datDispersion,datHuntLabelledEventsSBMerged_fixed,all.y=TRUE,by.x=c("frameN","expID","eventID"),by.y=c("startFrame","expID","eventID") )
  saveRDS(datHEventDispersion,file=paste0(strDataExportDir,"/huntEvent_mergedwith_Dispersion",tsec_timeWindow,"sec.rds") )
end.time <- Sys.time()
time.taken <- end.time - start.time
print(time.taken)
```

Here I will identify the number of hunt events evoked/initiated in each foraging state.
However, it is natural to expect that since hunt events involve slow prey approach behaviour, which gives low dispersion, a higher hunt-rate is expected in the exploitation state. Yet the time window of foraging state classification is 5 sec, while a hunt episodes last for less than 2 sec (~1sec If i remember correctly, check eLife paper fig).
Thus the foraging state is associated with slow/ prey approach motion, as a high rate of hunt initiation would cause low dispersion.  

Looking at a historgram normalized dispersion of hunt events it is clear that most of these exist over high dispersion, ie not in exploitation but rather in an exploratory phase!

It looks as if only the NF hunts during an exploitation type of movement.

```{r,  hunt-event-dispersion histogram Norm, fig.show="hold", out.width="50%", echo=FALSE, cache=TRUE }

## Get Number of Hunt Events In Exploit / Expore
table(convertToScoreLabel(datHuntLabelledEventsSBMerged_fixed$huntScore) )
table(convertToScoreLabel(datHEventDispersion[!is.na(datHEventDispersion$Dispersion_norm) & datHEventDispersion$Dispersion_norm > 0.2,]$huntScore) )
table(convertToScoreLabel(datHEventDispersion[!is.na(datHEventDispersion$Dispersion_norm) & datHEventDispersion$Dispersion_norm <= 0.2,]$huntScore) )
## Check number of Events missing dispersion Info
table(convertToScoreLabel(datHEventDispersion[!is.na(datHEventDispersion$Dispersion_norm)]$huntScore) )


hist(datHEventDispersion$Dispersion_norm,main="All group hunt events, ",xlab="Dispersion Norm.",breaks=100)

## Normalized Dispersion In Hunt Events
## Check LF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='LL', ]$Dispersion_norm,breaks=100,main="LF",xlab="Dispersion Norm.")

## Check NF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='NL', ]$Dispersion_norm,breaks=100,main="NF",xlab="Dispersion Norm.")

## Check DF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='DL', ]$Dispersion_norm,breaks=100,main="DF",xlab="Dispersion Norm.")

```

The same situation is found even if we remove the normalization stage, and look at raw dispersion measures, the low dispersion associated with exploitation phase is rare among hunt-events

```{r,  hunt-event-dispersion histogram raw, fig.show="hold", out.width="50%", echo=FALSE, cache=TRUE }

## RAW Dispersion In Hunt Events
## Check LF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='LL', ]$Dispersion,breaks=100,main="LF",xlab="Dispersion ",xlim=c(0,10))

## Check NF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='NL', ]$Dispersion,breaks=100,main="NF",xlab="Dispersion",xlim=c(0,10))

## Check DF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='DL', ]$Dispersion,breaks=100,main="DF",xlab="Dispersion",xlim=c(0,10))

```


## associations between hunt-outcome and foraging state
Do distributions of dispersion change depending on hunt-outcome ? 

The historgrams below examine how normalized dispersion distributions shift for each group depending on capture outcome being success/fail

```{r,  hunt-outcome-dispersion histogram norm, fig.show="hold", out.width="50%", echo=FALSE, cache=TRUE }

## RAW Dispersion In Hunt Events
## Check LF Successs/Fail Only
hist(datHEventDispersion[datHEventDispersion$groupID.y=='LL' & grepl("Success", as.character(  convertToScoreLabel(datHEventDispersion$huntScore) ) ) , ]$Dispersion_norm,breaks=100,main="LF Capture Success",xlab="Dispersion ",xlim=c(0,1))

hist(datHEventDispersion[datHEventDispersion$groupID.y=='LL' & grepl("Fail", as.character(  convertToScoreLabel(datHEventDispersion$huntScore) ) ) , ]$Dispersion_norm,breaks=100,main="LF Capture Fail",xlab="Dispersion ",xlim=c(0,1))

## Check NF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='NL' & grepl("Success", as.character(  convertToScoreLabel(datHEventDispersion$huntScore) ) ) , ]$Dispersion_norm,breaks=100,main="NF Capture Success",xlab="Dispersion ",xlim=c(0,1))

hist(datHEventDispersion[datHEventDispersion$groupID.y=='NL' & grepl("Fail", as.character(  convertToScoreLabel(datHEventDispersion$huntScore) ) ) , ]$Dispersion_norm,breaks=100,main="NF Capture Fail",xlab="Dispersion ",xlim=c(0,1))

## Check DF
hist(datHEventDispersion[datHEventDispersion$groupID.y=='DL' & grepl("Success", as.character(  convertToScoreLabel(datHEventDispersion$huntScore) ) ) , ]$Dispersion_norm,breaks=100,main="DF Capture Success",xlab="Dispersion ",xlim=c(0,1))

hist(datHEventDispersion[datHEventDispersion$groupID.y=='DL' & grepl("Fail", as.character(  convertToScoreLabel(datHEventDispersion$huntScore) ) ) , ]$Dispersion_norm,breaks=100,main="DF Capture Fail",xlab="Dispersion ",xlim=c(0,1))

```



# Full figure List of trajectories per experiment
The following figures show the tracked trajectories per experiment of each group. Trajectory segments are colour coded according to whether these can be classified as exploration or exploitation based on ta theshold on the normalized dispersion. This threshold is set here to `r thres_dispersion_class ` .
Red signiifies segments of exploitation, blue is for exploration.

## Classifying exploitation/exploration phases based on global threshold 
The dispersion of each experiment is normalized globally and thus classification threhsold for exploitation identifies trajectory segments of spatially restricted motion relative to all larvae across groups

### Evoked conditions
Trajectories of 10min recordings in the presence of prey. Note, in contrast to Marquez et al. 2019, our recodings exclude motion at the boundary of petridish.

#### LF - Evoked Trajectories
```{r,  global_norm-trajectories-LL, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE }

plotGlobalNormDispersionTrajectories('LL',datAllFrames,datDispersion , thres_dispersion_class )

```

#### NF - Evoked Trajectories 
```{r, global_norm-trajectories-NL, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotGlobalNormDispersionTrajectories('NL',datAllFrames,datDispersion , thres_dispersion_class )

```

#### DF - Evoked Trajectories 
```{r, global_norm-trajectories-DL, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotGlobalNormDispersionTrajectories('DL',datAllFrames,datDispersion , 0.2)
```

#### Spontaneous conditions
### LF - Spontaneous Trajectories
```{r,  global_norm-trajectories-LE, fig.show="hold", out.width="50%", echo=FALSE, results='hide' ,cache=TRUE}

plotGlobalNormDispersionTrajectories('LL',datAllFrames,datDispersion , thres_dispersion_class )

```

#### NF - Spontaneous Trajectories 
```{r, global_norm-trajectories-NE, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotGlobalNormDispersionTrajectories('NE',datAllFrames,datDispersion , thres_dispersion_class )

```

#### DF - Spontaneous Trajectories 
```{r, global_norm-trajectories-DE, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotGlobalNormDispersionTrajectories('DE',datAllFrames,datDispersion , 0.2)
```


## Normalized Per Larval experiment
Note that Spontaneous and Evoked conditions of each larva are considered individually

#### LF - Evoked Trajectories
```{r,  exp_norm-trajectories-LL, fig.show="hold", out.width="50%", echo=FALSE, results='hide' , cache=TRUE}

plotExpNormDispersionTrajectories('LL',datAllFrames,datDispersion , thres_dispersion_class )

```

#### NF - Evoked Trajectories 
```{r, exp_norm-trajectories-NL, fig.show="hold", out.width="50%", echo=FALSE, results='hide',cache=TRUE}

plotExpNormDispersionTrajectories('NL',datAllFrames,datDispersion , thres_dispersion_class )

```

#### DF - Evoked Trajectories 
```{r, exp_norm-trajectories-DL, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotExpNormDispersionTrajectories('DL',datAllFrames,datDispersion , 0.2)
```

#### Spontaneous conditions
### LF - Spontaneous Trajectories
```{r,  exp_norm-trajectories-LE, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE }

plotExpNormDispersionTrajectories('LL',datAllFrames,datDispersion , thres_dispersion_class )

```

#### NF - Spontaneous Trajectories 
```{r, exp_norm-trajectories-NE, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotExpNormDispersionTrajectories('NE',datAllFrames,datDispersion , thres_dispersion_class )

```

#### DF - Spontaneous Trajectories 
```{r, exp_norm-trajectories-DE, fig.show="hold", out.width="50%", echo=FALSE, results='hide', cache=TRUE}

plotExpNormDispersionTrajectories('DE',datAllFrames,datDispersion , 0.2)
```



```{r,spare-code-notes,include=FALSE}
### Retrieve Dispersion of each Hunt Event
 start.time <- Sys.time()
 i <- 0
 for (i in 1:NROW(datHuntLabelledEventsSBMerged_fixed) )
 {

    datHEvent_disp <- datDispersion[datDispersion$expID == datHuntLabelledEventsSBMerged_fixed[i,]$expID & 
                               datDispersion$eventID == datHuntLabelledEventsSBMerged_fixed[i,]$eventID &  
                               datDispersion$frameN == datHuntLabelledEventsSBMerged_fixed[i,]$startFrame ,] #
    #message(datHEvent_disp$expID)  
   
    if (NROW(datHEvent_disp) == 0 )
    {
      warning("Tracking dispersion data not found for huntevent ",i, "at startframe ",datHuntLabelledEventsSBMerged_fixed[i,]$startFrame )
      ##Try Again without the start frame - Slower
      datHEvent_disp <- datDispersion[datDispersion$expID == datHuntLabelledEventsSBMerged_fixed[i,]$expID & 
                               datDispersion$eventID == datHuntLabelledEventsSBMerged_fixed[i,]$eventID  ,] #
    }
    
    if (NROW(datHEvent_disp) == 0 )
      warning("Attaching dispersion data for huntevent ",i, " Failed")
    
    # Check if Rec Exists
    if (NROW(datHEvent_disp) == 1 )
    {
      
      vHuntEventDispersion[i] <- datHEvent_disp$Dispersion
      vHuntEventDispersion_norm[i] <-  datHEvent_disp$Dispersion_norm
      message(i," Disp:",vHuntEventDispersion[i])
      
    }else {
  
      ## Multiple rows returned
      ## FInd Tracking (Dispersion dat) frame that is closest to hunt-event initiation (start frame)
      idx <- NA
      with(datHuntLabelledEventsSBMerged_fixed[i,],
           {
                 idx <- which(abs(datHEvent_disp$frameN - startFrame) == min(abs(datHEvent_disp$frameN - startFrame) ) )
                
                 vHuntEventDispersion_norm[i] <- datHEvent_disp[idx,"Dispersion_norm"]
                 vHuntEventDispersion[i] <- datHEvent_disp[idx,"Dispersion"]
                ##This Maybe NA since there are no Dispersion Data In some Occassions
                ##stopifnot(!is.na(vHuntEventDispersion[i]))
                message("Found idx ",idx, " Disp ",vHuntEventDispersion[i])
           })
      
    }

     #Find Dispersion At start Frame of Hunt Event
     #
     print(i)    
    

     #stopifnot(i <11)
 }
 
    end.time <- Sys.time()
    time.taken <- end.time - start.time
    print(time.taken)

 
```